#!/usr/bin/env bash
#
# Setups parse-server, in an easy fashion
# Used to running Test Cases against the parse-php-sdk
#

# Verify parse-server is installed
hasServer=`npm -g list | grep parse-server@`
if [ "$hasServer" = "" ];
then
    echo "> installing parse-server..."
    npm install -g parse-server

else
    echo "* Found parse-server"
fi

# Verify mongodb is installed
#hasMongo=`npm -g list | grep mongodb@`
#if [ "$hasMongo" = "" ];
#then
#    echo "Installing mongodb..."
#    npm install -g mongodb
#
#else
#    echo "* Found mongodb"
#fi

# Verify mongo-runner is installed
hasMongoRunner=`npm -g list | grep mongodb-runner@`
if [ "$hasMongoRunner" = "" ];
then
    echo "> installing mongodb-runner..."
    npm install -g mongodb-runner

else
    echo "* Found mongodb-runner"
fi

# Run updates just in case
npm update -g

# Start MongoDB
mongodb-runner start

# space out commands from mongodb-runner
echo ""
echo ""

# Set environment variables
#VERBOSE='1'

# Start ParseServer from the command line, not we are using cloud code as well
parse-server\
    --appName MyTestApp\
    --appId app-id-here\
    --masterKey master-key-here\
    --databaseURI mongodb://localhost/test\
    --cloud `pwd`/cloud-code.js\
    --push '{"android":{"senderId":"blank-sender-id","apiKey":"some-api-key"}}'\
    --emailAdapter '{"module":"parse-server-simple-mailgun-adapter","options":{"apiKey":"arbitrary-api-key","domain":"example.com","fromAddress":"example@example.com"}}'\
    --publicServerURL http://localhost:1337/parse\


# Stop MongoDB
mongodb-runner stop